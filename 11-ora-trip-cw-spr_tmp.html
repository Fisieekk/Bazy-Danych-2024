<!DOCTYPE html>
<html>
<head>
<title>11-ora-trip-cw-spr.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 9px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="oracle-plsql">Oracle PL/Sql</h1>
<p>widoki, funkcje, procedury, triggery
ćwiczenie</p>
<hr>
<p>Imiona i nazwiska autorów :</p>
<hr>
<style>
  {
    font-size: 16pt;
  }
</style>
<style scoped>
 li, p {
    font-size: 14pt;
  }
</style>
<style scoped>
 pre {
    font-size: 10pt;
  }
</style>
<h1 id="tabele">Tabele</h1>
<p><img src="file:///c:/Users/wojci/Git repositories/Bazy-Danych-2024/_img/ora-trip1-0.png" alt=""></p>
<ul>
<li>
<p><code>Trip</code> - wycieczki</p>
<ul>
<li><code>trip_id</code> - identyfikator, klucz główny</li>
<li><code>trip_name</code> - nazwa wycieczki</li>
<li><code>country</code> - nazwa kraju</li>
<li><code>trip_date</code> - data</li>
<li><code>max_no_places</code> - maksymalna liczba miejsc na wycieczkę</li>
</ul>
</li>
<li>
<p><code>Person</code> - osoby</p>
<ul>
<li><code>person_id</code> - identyfikator, klucz główny</li>
<li><code>firstname</code> - imię</li>
<li><code>lastname</code> - nazwisko</li>
</ul>
</li>
<li>
<p><code>Reservation</code> - rezerwacje</p>
<ul>
<li><code>reservation_id</code> - identyfikator, klucz główny</li>
<li><code>trip_id</code> - identyfikator wycieczki</li>
<li><code>person_id</code> - identyfikator osoby</li>
<li><code>status</code> - status rezerwacji
<ul>
<li><code>N</code> – New - Nowa</li>
<li><code>P</code> – Confirmed and Paid – Potwierdzona  i zapłacona</li>
<li><code>C</code> – Canceled - Anulowana</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>Log</code> - dziennik zmian statusów rezerwacji</p>
<ul>
<li><code>log_id</code> - identyfikator, klucz główny</li>
<li><code>reservation_id</code> - identyfikator rezerwacji</li>
<li><code>log_date</code> - data zmiany</li>
<li><code>status</code> - status</li>
</ul>
</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">sequence</span> s_person_seq
   <span class="hljs-keyword">start</span> <span class="hljs-keyword">with</span> <span class="hljs-number">1</span>
   <span class="hljs-keyword">increment</span> <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>;

<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> person
(
  person_id <span class="hljs-built_in">int</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>
      <span class="hljs-keyword">constraint</span> pk_person
         primary <span class="hljs-keyword">key</span>,
  firstname <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>),
  lastname <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>)
)

<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> person
    <span class="hljs-keyword">modify</span> person_id <span class="hljs-built_in">int</span> <span class="hljs-keyword">default</span> s_person_seq.nextval;

</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">sequence</span> s_trip_seq
   <span class="hljs-keyword">start</span> <span class="hljs-keyword">with</span> <span class="hljs-number">1</span>
   <span class="hljs-keyword">increment</span> <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>;

<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> trip
(
  trip_id <span class="hljs-built_in">int</span>  <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>
     <span class="hljs-keyword">constraint</span> pk_trip
         primary <span class="hljs-keyword">key</span>,
  trip_name <span class="hljs-built_in">varchar</span>(<span class="hljs-number">100</span>),
  country <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>),
  trip_date <span class="hljs-built_in">date</span>,
  max_no_places <span class="hljs-built_in">int</span>
)

<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> trip
    <span class="hljs-keyword">modify</span> trip_id <span class="hljs-built_in">int</span> <span class="hljs-keyword">default</span> s_trip_seq.nextval;
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">sequence</span> s_reservation_seq
   <span class="hljs-keyword">start</span> <span class="hljs-keyword">with</span> <span class="hljs-number">1</span>
   <span class="hljs-keyword">increment</span> <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>;

<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> reservation
(
  reservation_id <span class="hljs-built_in">int</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>
      <span class="hljs-keyword">constraint</span> pk_reservation
         primary <span class="hljs-keyword">key</span>,
  trip_id <span class="hljs-built_in">int</span>,
  person_id <span class="hljs-built_in">int</span>,
  <span class="hljs-keyword">status</span> <span class="hljs-built_in">char</span>(<span class="hljs-number">1</span>)
)

<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> reservation
    <span class="hljs-keyword">modify</span> reservation_id <span class="hljs-built_in">int</span> <span class="hljs-keyword">default</span> s_reservation_seq.nextval;


<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> reservation
<span class="hljs-keyword">add</span> <span class="hljs-keyword">constraint</span> reservation_fk1 <span class="hljs-keyword">foreign</span> <span class="hljs-keyword">key</span>
( person_id ) <span class="hljs-keyword">references</span> person ( person_id );

<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> reservation
<span class="hljs-keyword">add</span> <span class="hljs-keyword">constraint</span> reservation_fk2 <span class="hljs-keyword">foreign</span> <span class="hljs-keyword">key</span>
( trip_id ) <span class="hljs-keyword">references</span> trip ( trip_id );

<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> reservation
<span class="hljs-keyword">add</span> <span class="hljs-keyword">constraint</span> reservation_chk1 <span class="hljs-keyword">check</span>
(<span class="hljs-keyword">status</span> <span class="hljs-keyword">in</span> (<span class="hljs-string">'N'</span>,<span class="hljs-string">'P'</span>,<span class="hljs-string">'C'</span>));

</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">sequence</span> s_log_seq
   <span class="hljs-keyword">start</span> <span class="hljs-keyword">with</span> <span class="hljs-number">1</span>
   <span class="hljs-keyword">increment</span> <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>;


<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">log</span>
(
    log_id <span class="hljs-built_in">int</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>
         <span class="hljs-keyword">constraint</span> pk_log
         primary <span class="hljs-keyword">key</span>,
    reservation_id <span class="hljs-built_in">int</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
    log_date datetime  <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
    <span class="hljs-keyword">status</span> <span class="hljs-built_in">char</span>(<span class="hljs-number">1</span>)
);

<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">log</span>
    <span class="hljs-keyword">modify</span> log_id <span class="hljs-built_in">int</span> <span class="hljs-keyword">default</span> s_log_seq.nextval;

<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">log</span>
<span class="hljs-keyword">add</span> <span class="hljs-keyword">constraint</span> log_chk1 <span class="hljs-keyword">check</span>
(<span class="hljs-keyword">status</span> <span class="hljs-keyword">in</span> (<span class="hljs-string">'N'</span>,<span class="hljs-string">'P'</span>,<span class="hljs-string">'C'</span>)) <span class="hljs-keyword">enable</span>;

<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">log</span>
<span class="hljs-keyword">add</span> <span class="hljs-keyword">constraint</span> log_fk1 <span class="hljs-keyword">foreign</span> <span class="hljs-keyword">key</span>
( reservation_id ) <span class="hljs-keyword">references</span> reservation ( reservation_id );
</div></code></pre>
<hr>
<h1 id="dane">Dane</h1>
<p>Należy wypełnić tabele przykładowymi danymi</p>
<ul>
<li>4 wycieczki</li>
<li>10 osób</li>
<li>10 rezerwacji</li>
</ul>
<p>Dane testowe powinny być różnorodne (wycieczki w przyszłości, wycieczki w przeszłości, rezerwacje o różnym statusie itp.) tak, żeby umożliwić testowanie napisanych procedur.</p>
<p>W razie potrzeby należy zmodyfikować dane tak żeby przetestować różne przypadki.</p>
<pre class="hljs"><code><div><span class="hljs-comment">-- trip</span>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> trip(trip_name, country, trip_date, max_no_places)
<span class="hljs-keyword">values</span> (<span class="hljs-string">'Wycieczka do Paryza'</span>, <span class="hljs-string">'Francja'</span>, <span class="hljs-keyword">to_date</span>(<span class="hljs-string">'2023-09-12'</span>, <span class="hljs-string">'YYYY-MM-DD'</span>), <span class="hljs-number">3</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> trip(trip_name, country, trip_date,  max_no_places)
<span class="hljs-keyword">values</span> (<span class="hljs-string">'Piekny Krakow'</span>, <span class="hljs-string">'Polska'</span>, <span class="hljs-keyword">to_date</span>(<span class="hljs-string">'2025-05-03'</span>,<span class="hljs-string">'YYYY-MM-DD'</span>), <span class="hljs-number">2</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> trip(trip_name, country, trip_date,  max_no_places)
<span class="hljs-keyword">values</span> (<span class="hljs-string">'Znow do Francji'</span>, <span class="hljs-string">'Francja'</span>, <span class="hljs-keyword">to_date</span>(<span class="hljs-string">'2025-05-01'</span>,<span class="hljs-string">'YYYY-MM-DD'</span>), <span class="hljs-number">2</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> trip(trip_name, country, trip_date,  max_no_places)
<span class="hljs-keyword">values</span> (<span class="hljs-string">'Hel'</span>, <span class="hljs-string">'Polska'</span>, <span class="hljs-keyword">to_date</span>(<span class="hljs-string">'2025-05-01'</span>,<span class="hljs-string">'YYYY-MM-DD'</span>),  <span class="hljs-number">2</span>);

<span class="hljs-comment">-- person</span>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person(firstname, lastname)
<span class="hljs-keyword">values</span> (<span class="hljs-string">'Jan'</span>, <span class="hljs-string">'Nowak'</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person(firstname, lastname)
<span class="hljs-keyword">values</span> (<span class="hljs-string">'Jan'</span>, <span class="hljs-string">'Kowalski'</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person(firstname, lastname)
<span class="hljs-keyword">values</span> (<span class="hljs-string">'Jan'</span>, <span class="hljs-string">'Nowakowski'</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person(firstname, lastname)
<span class="hljs-keyword">values</span>  (<span class="hljs-string">'Novak'</span>, <span class="hljs-string">'Nowak'</span>);

<span class="hljs-comment">-- reservation</span>
<span class="hljs-comment">-- trip1</span>
<span class="hljs-keyword">insert</span>  <span class="hljs-keyword">into</span> reservation(trip_id, person_id, <span class="hljs-keyword">status</span>)
<span class="hljs-keyword">values</span> (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'P'</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> reservation(trip_id, person_id, <span class="hljs-keyword">status</span>)
<span class="hljs-keyword">values</span> (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'N'</span>);

<span class="hljs-comment">-- trip 2</span>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> reservation(trip_id, person_id, <span class="hljs-keyword">status</span>)
<span class="hljs-keyword">values</span> (<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'P'</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> reservation(trip_id, person_id, <span class="hljs-keyword">status</span>)
<span class="hljs-keyword">values</span> (<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-string">'C'</span>);

<span class="hljs-comment">-- trip 3</span>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> reservation(trip_id, person_id, <span class="hljs-keyword">status</span>)
<span class="hljs-keyword">values</span> (<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-string">'P'</span>);
</div></code></pre>
<hr>
<h1 id="zadanie-0---modyfikacja-danych-transakcje">Zadanie 0 - modyfikacja danych, transakcje</h1>
<p>Należy przeprowadzić kilka eksperymentów związanych ze wstawianiem, modyfikacją i usuwaniem danych
oraz wykorzystaniem transakcji</p>
<p>Skomentuj dzialanie transakcji. Jak działa polecenie <code>commit</code>, <code>rollback</code>?.
Co się dzieje w przypadku wystąpienia błędów podczas wykonywania transakcji? Porównaj sposób programowania operacji wykorzystujących transakcje w Oracle PL/SQL ze znanym ci systemem/językiem MS Sqlserver T-SQL</p>
<p>pomocne mogą być materiały dostępne tu:
https://upel.agh.edu.pl/mod/folder/view.php?id=214774
w szczególności dokument: <code>1_modyf.pdf</code></p>
<pre class="hljs"><code><div>
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">update</span> trip <span class="hljs-keyword">set</span> country = <span class="hljs-string">'Niemcy'</span> <span class="hljs-keyword">where</span> trip_id = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">rollback</span>;
<span class="hljs-keyword">end</span>;

<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person(firstname, lastname) <span class="hljs-keyword">values</span> (<span class="hljs-string">'Żaneta'</span>, <span class="hljs-string">'Kowalska'</span>);
    <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person(firstname, lastname) <span class="hljs-keyword">values</span> (<span class="hljs-string">'Janek'</span>, <span class="hljs-string">'Rapowanie'</span>);
    <span class="hljs-keyword">commit</span>;
<span class="hljs-keyword">end</span>;
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">update</span> person <span class="hljs-keyword">set</span> person_id = <span class="hljs-number">11</span> <span class="hljs-keyword">where</span> firstname = <span class="hljs-string">'Żaneta'</span> <span class="hljs-keyword">and</span> lastname = <span class="hljs-string">'Kowalska'</span>;
    <span class="hljs-keyword">commit</span>;
<span class="hljs-keyword">end</span>;
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">update</span> person <span class="hljs-keyword">set</span> person_id = <span class="hljs-number">12</span> <span class="hljs-keyword">where</span> firstname = <span class="hljs-string">'Janek'</span> <span class="hljs-keyword">and</span> lastname = <span class="hljs-string">'Rapowanie'</span>;
    <span class="hljs-keyword">commit</span>;
<span class="hljs-keyword">end</span>;
<span class="hljs-comment">-- bez commita nie usuwa z tabeli</span>
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">from</span> person <span class="hljs-keyword">where</span> person_id = <span class="hljs-number">11</span>;
    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">from</span> person <span class="hljs-keyword">where</span> person_id = <span class="hljs-number">12</span>;
<span class="hljs-keyword">end</span>;


<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">from</span> person <span class="hljs-keyword">where</span> person_id = <span class="hljs-number">11</span>;
    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">from</span> person <span class="hljs-keyword">where</span> person_id = <span class="hljs-number">12</span>;
    <span class="hljs-keyword">commit</span>;
<span class="hljs-keyword">end</span>;


Transakcjami nazywami zagnieżdżone w blokach <span class="hljs-keyword">begin</span> <span class="hljs-keyword">end</span> linijki kodu,
wykonujące pewne operacje na systemie bazy danych. <span class="hljs-keyword">Do</span> transakcji używane są polecenia
<span class="hljs-keyword">commit</span> i <span class="hljs-keyword">rollback</span> - <span class="hljs-keyword">rollback</span> wycofuje wprowadzenie zmian, <span class="hljs-keyword">commit</span> natomiast zatwierdza
zmiany <span class="hljs-keyword">do</span> bazy danych. W praktyce polecenia <span class="hljs-keyword">rollback</span> używamy zabezpieczając się przed
potencjalnymi błędami, tak żeby zmiany nie zaszły częściowo, jeśli wprowadzone dane
nie są poprawne bądź występują jakieś inne problemy skutkujące wyrzuceniem błędu - usuwanie
części danych ręcznie, zeby nastepnie wprowadzic holistycznie calosc zmian byloby niepraktyczne. 
Języki MS SQLserver T-<span class="hljs-keyword">SQL</span> i <span class="hljs-keyword">Oracle</span> PL/<span class="hljs-keyword">SQL</span> mają wiele podobieństw w sposobie wykorzystywania
transakcji, w obu mozemy dane w transakcjach wstawiac, usuwac. Oprocz tego uzywac
polecen <span class="hljs-keyword">commit</span> i <span class="hljs-keyword">rollback</span>, definiowac bloki transakcji. Z istotniejszych roznic
mozna wskazac obsluge bledow - w PL/<span class="hljs-keyword">SQL</span> wystepuja <span class="hljs-keyword">exceptions</span> zamiast blokow try catch w T-SQLu.
Dodatkowo transakcje w PL/<span class="hljs-keyword">SQL</span> są obsługiwane w sposób niejawny - każde polecenie <span class="hljs-keyword">SQL</span> jest
domyślnie częścią transakcji, a w T-<span class="hljs-keyword">SQL</span> mamy <span class="hljs-keyword">to</span> zrobione w sposób jawny 

</div></code></pre>
<hr>
<h1 id="zadanie-1---widoki">Zadanie 1 - widoki</h1>
<p>Tworzenie widoków. Należy przygotować kilka widoków ułatwiających dostęp do danych. Należy zwrócić uwagę na strukturę kodu (należy unikać powielania kodu)</p>
<p>Widoki:</p>
<ul>
<li><code>vw_reservation</code>
<ul>
<li>widok łączy dane z tabel: <code>trip</code>, <code>person</code>, <code>reservation</code></li>
<li>zwracane dane: <code>reservation_id</code>, <code>country</code>, <code>trip_date</code>, <code>trip_name</code>, <code>firstname</code>, <code>lastname</code>, <code>status</code>, <code>trip_id</code>, <code>person_id</code></li>
</ul>
</li>
<li><code>vw_trip</code>
<ul>
<li>widok pokazuje liczbę wolnych miejsc na każdą wycieczkę</li>
<li>zwracane dane: <code>trip_id</code>, <code>country</code>, <code>trip_date</code>, <code>trip_name</code>, <code>max_no_places</code>, <code>no_available_places</code> (liczba wolnych miejsc)</li>
</ul>
</li>
<li><code>vw_available_trip</code>
<ul>
<li>podobnie jak w poprzednim punkcie, z tym że widok pokazuje jedynie dostępne wycieczki (takie które są w przyszłości i są na nie wolne miejsca)</li>
</ul>
</li>
</ul>
<p>Proponowany zestaw widoków można rozbudować wedle uznania/potrzeb</p>
<ul>
<li>np. można dodać nowe/pomocnicze widoki</li>
<li>np. można zmienić def. widoków, dodając nowe/potrzebne pola</li>
</ul>
<h1 id="zadanie-1---rozwi%C4%85zanie">Zadanie 1 - rozwiązanie</h1>
<pre class="hljs"><code><div>
<span class="hljs-comment">-- Widok rezerwacji</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> vw_reservation <span class="hljs-keyword">as</span>
<span class="hljs-keyword">select</span>
    r.RESERVATION_ID,
    t.COUNTRY,
    t.TRIP_DATE,
    t.TRIP_NAME,
    p.FIRSTNAME,
    p.LASTNAME,
    r.STATUS,
    t.TRIP_ID,
    p.PERSON_ID
<span class="hljs-keyword">from</span>
    RESERVATION r
<span class="hljs-keyword">join</span>
        trip t <span class="hljs-keyword">on</span> r.TRIP_ID = t.TRIP_ID
<span class="hljs-keyword">join</span>
        person p <span class="hljs-keyword">on</span> r.PERSON_ID = p.PERSON_ID
<span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> r.RESERVATION_ID;


<span class="hljs-comment">-- Widok który dla każdej wycieczki podaje liczbę już zajętych miejsc</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> vw_taken_places <span class="hljs-keyword">as</span>
<span class="hljs-keyword">select</span> <span class="hljs-keyword">distinct</span>
    r.TRIP_ID,
    (<span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(*) <span class="hljs-keyword">from</span> RESERVATION r1
    <span class="hljs-keyword">where</span> r.TRIP_ID=r1.TRIP_ID <span class="hljs-keyword">and</span> (r1.STATUS !=<span class="hljs-string">'C'</span>)
    <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> r1.TRIP_ID) <span class="hljs-keyword">as</span> taken_places
<span class="hljs-keyword">from</span> RESERVATION r;

<span class="hljs-comment">-- Widok wszystkich wycieczek z użyciem widoku vw_taken_places</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> vw_trip <span class="hljs-keyword">as</span>
<span class="hljs-keyword">select</span>
    t.TRIP_ID,
    t.COUNTRY,
    t.TRIP_DATE,
    t.TRIP_NAME,
    t.MAX_NO_PLACES,
    t.MAX_NO_PLACES - (<span class="hljs-keyword">select</span> t1.TAKEN_PLACES
     <span class="hljs-keyword">from</span> VW_TAKEN_PLACES t1
     <span class="hljs-keyword">where</span> t1.TRIP_ID = t.TRIP_ID) <span class="hljs-keyword">as</span> no_available_places
<span class="hljs-keyword">from</span> TRIP t


<span class="hljs-comment">-- Widok tylko dostępnych wycieczek</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> vw_available_trip <span class="hljs-keyword">as</span>
<span class="hljs-keyword">select</span>
    *
<span class="hljs-keyword">from</span> VW_TRIP
<span class="hljs-keyword">where</span> TRIP_DATE &gt; <span class="hljs-keyword">SYSDATE</span> <span class="hljs-keyword">and</span> NO_AVAILABLE_PLACES &gt; <span class="hljs-number">0</span>;

</div></code></pre>
<hr>
<h1 id="zadanie-2---funkcje">Zadanie 2 - funkcje</h1>
<p>Tworzenie funkcji pobierających dane/tabele. Podobnie jak w poprzednim przykładzie należy przygotować kilka funkcji ułatwiających dostęp do danych</p>
<p>Procedury:</p>
<ul>
<li><code>f_trip_participants</code>
<ul>
<li>zadaniem funkcji jest zwrócenie listy uczestników wskazanej wycieczki</li>
<li>parametry funkcji: <code>trip_id</code></li>
<li>funkcja zwraca podobny zestaw danych jak widok <code>vw_eservation</code></li>
</ul>
</li>
<li><code>f_person_reservations</code>
<ul>
<li>zadaniem funkcji jest zwrócenie listy rezerwacji danej osoby</li>
<li>parametry funkcji: <code>person_id</code></li>
<li>funkcja zwraca podobny zestaw danych jak widok <code>vw_reservation</code></li>
</ul>
</li>
<li><code>f_available_trips_to</code>
<ul>
<li>zadaniem funkcji jest zwrócenie listy wycieczek do wskazanego kraju, dostępnych w zadanym okresie czasu (od <code>date_from</code> do <code>date_to</code>)</li>
<li>parametry funkcji: <code>country</code>, <code>date_from</code>, <code>date_to</code></li>
</ul>
</li>
</ul>
<p>Funkcje powinny zwracać tabelę/zbiór wynikowy. Należy rozważyć dodanie kontroli parametrów, (np. jeśli parametrem jest <code>trip_id</code> to można sprawdzić czy taka wycieczka istnieje). Podobnie jak w przypadku widoków należy zwrócić uwagę na strukturę kodu</p>
<p>Czy kontrola parametrów w przypadku funkcji ma sens?</p>
<ul>
<li>jakie są zalety/wady takiego rozwiązania?</li>
</ul>
<p>Proponowany zestaw funkcji można rozbudować wedle uznania/potrzeb</p>
<ul>
<li>np. można dodać nowe/pomocnicze funkcje/procedury</li>
</ul>
<h1 id="zadanie-2---rozwi%C4%85zanie">Zadanie 2 - rozwiązanie</h1>
<pre class="hljs"><code><div><span class="hljs-comment">-- funkcja pomocnicza do sprawdzania czy istnieje trip o danym id</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">function</span> f_trip_exists(t_id <span class="hljs-keyword">in</span> TRIP.TRIP_ID%<span class="hljs-keyword">type</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">boolean</span>
<span class="hljs-keyword">as</span>
    exist <span class="hljs-built_in">number</span>;
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">select</span> <span class="hljs-keyword">case</span>
            <span class="hljs-keyword">when</span> <span class="hljs-keyword">exists</span>(<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> TRIP <span class="hljs-keyword">where</span> TRIP_ID = t_id) <span class="hljs-keyword">then</span> <span class="hljs-number">1</span>
            <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">into</span> exist <span class="hljs-keyword">from</span> dual;

    if exist = 1 then
        return true;
    else
        return false;
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;
<span class="hljs-keyword">end</span>;
/



<span class="hljs-comment">--f_trip_participants</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">function</span> f_trip_participants(t_id <span class="hljs-built_in">int</span>)
    <span class="hljs-keyword">return</span> TRIP_PARTICIPANTS_TABLE
<span class="hljs-keyword">as</span>
    <span class="hljs-keyword">result</span> TRIP_PARTICIPANTS_TABLE;
    vaild int;
<span class="hljs-keyword">begin</span>
    
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> F_TRIP_EXISTS(t_id) <span class="hljs-keyword">then</span>
        raise_application_error(<span class="hljs-number">-20001</span>,<span class="hljs-string">'trip not found'</span>);
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;

    <span class="hljs-keyword">select</span> TRIP_PARTICIPANT(PERSON_ID,FIRSTNAME,LASTNAME,RESERVATION_ID,COUNTRY,TRIP_DATE,TRIP_NAME,<span class="hljs-keyword">STATUS</span>)
    <span class="hljs-keyword">bulk</span> <span class="hljs-keyword">collect</span>
    <span class="hljs-keyword">into</span> <span class="hljs-keyword">result</span>
    <span class="hljs-keyword">from</span> VW_RESERVATION
    <span class="hljs-keyword">where</span> TRIP_ID = t_id <span class="hljs-keyword">and</span> <span class="hljs-keyword">STATUS</span> != <span class="hljs-string">'C'</span>;

    return result;
<span class="hljs-keyword">end</span>;
/



<span class="hljs-comment">-- funkcja pomocnicza sprawdzająca czy osoba o danym id istnieje</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">function</span> f_person_exists(p_id <span class="hljs-keyword">in</span> person.PERSON_ID%<span class="hljs-keyword">type</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">boolean</span>
<span class="hljs-keyword">as</span>
    exist <span class="hljs-built_in">number</span>;
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">select</span> <span class="hljs-keyword">case</span>
            <span class="hljs-keyword">when</span> <span class="hljs-keyword">exists</span>(<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> PERSON <span class="hljs-keyword">where</span> PERSON_ID = p_id) <span class="hljs-keyword">then</span> <span class="hljs-number">1</span>
            <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">into</span> exist <span class="hljs-keyword">from</span> dual;

    if exist = 1 then
        return true;
    else
        return false;
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;
<span class="hljs-keyword">end</span>;
/




<span class="hljs-comment">--f_person_reservations</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">function</span> f_person_reservations(p_id <span class="hljs-built_in">int</span> )
    <span class="hljs-keyword">return</span> person_reservation_table
<span class="hljs-keyword">as</span>
    <span class="hljs-keyword">result</span> person_reservation_table;
    valid int;
<span class="hljs-keyword">begin</span>

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> F_PERSON_EXISTS(p_id) <span class="hljs-keyword">then</span>
        raise_application_error(<span class="hljs-number">-20001</span>,<span class="hljs-string">'person not found'</span>);
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;

    <span class="hljs-keyword">select</span> person_reservation(PERSON_ID,RESERVATION_ID,TRIP_ID,FIRSTNAME,LASTNAME,COUNTRY,TRIP_DATE,TRIP_NAME,<span class="hljs-keyword">STATUS</span>)
    <span class="hljs-keyword">bulk</span> <span class="hljs-keyword">collect</span>
    <span class="hljs-keyword">into</span> <span class="hljs-keyword">result</span>
    <span class="hljs-keyword">from</span> VW_RESERVATION
    <span class="hljs-keyword">where</span> PERSON_ID = p_id;

    return result;
<span class="hljs-keyword">end</span>;



<span class="hljs-comment">--f_available_trips_to</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">function</span> f_available_trips_to(f_country <span class="hljs-built_in">varchar</span>,date_from <span class="hljs-built_in">date</span>, date_to <span class="hljs-built_in">date</span>)
    <span class="hljs-keyword">return</span> available_trips_to_table
<span class="hljs-keyword">as</span>
    <span class="hljs-keyword">result</span> available_trips_to_table;
<span class="hljs-keyword">begin</span>

    <span class="hljs-keyword">select</span> available_trip_to(TRIP_ID,COUNTRY,TRIP_DATE,TRIP_NAME,MAX_NO_PLACES,NO_AVAILABLE_PLACES)
    <span class="hljs-keyword">bulk</span> <span class="hljs-keyword">collect</span>
    <span class="hljs-keyword">into</span> <span class="hljs-keyword">result</span>
    <span class="hljs-keyword">from</span> VW_AVAILABLE_TRIP
    <span class="hljs-keyword">where</span> COUNTRY = f_country <span class="hljs-keyword">and</span> TRIP_DATE <span class="hljs-keyword">between</span> date_from <span class="hljs-keyword">and</span> date_to;

    return result;
<span class="hljs-keyword">end</span>;

</div></code></pre>
<hr>
<h1 id="zadanie-3---procedury">Zadanie 3 - procedury</h1>
<p>Tworzenie procedur modyfikujących dane. Należy przygotować zestaw procedur pozwalających na modyfikację danych oraz kontrolę poprawności ich wprowadzania</p>
<p>Procedury</p>
<ul>
<li><code>p_add_reservation</code>
<ul>
<li>zadaniem procedury jest dopisanie nowej rezerwacji</li>
<li>parametry: <code>trip_id</code>, <code>person_id</code>,</li>
<li>procedura powinna kontrolować czy wycieczka jeszcze się nie odbyła, i czy sa wolne miejsca</li>
<li>procedura powinna również dopisywać inf. do tabeli <code>log</code></li>
</ul>
</li>
<li><code>p_modify_reservation_tatus</code>
<ul>
<li>zadaniem procedury jest zmiana statusu rezerwacji</li>
<li>parametry: <code>reservation_id</code>, <code>status</code></li>
<li>procedura powinna kontrolować czy możliwa jest zmiana statusu, np. zmiana statusu już anulowanej wycieczki (przywrócenie do stanu aktywnego nie zawsze jest możliwa – może już nie być miejsc)</li>
<li>procedura powinna również dopisywać inf. do tabeli <code>log</code></li>
</ul>
</li>
</ul>
<p>Procedury:</p>
<ul>
<li><code>p_modify_max_no_places</code>
<ul>
<li>zadaniem procedury jest zmiana maksymalnej liczby miejsc na daną wycieczkę</li>
<li>parametry: <code>trip_id</code>, <code>max_no_places</code></li>
<li>nie wszystkie zmiany liczby miejsc są dozwolone, nie można zmniejszyć liczby miejsc na wartość poniżej liczby zarezerwowanych miejsc</li>
</ul>
</li>
</ul>
<p>Należy rozważyć użycie transakcji</p>
<p>Należy zwrócić uwagę na kontrolę parametrów (np. jeśli parametrem jest trip_id to należy sprawdzić czy taka wycieczka istnieje, jeśli robimy rezerwację to należy sprawdzać czy są wolne miejsca itp..)</p>
<p>Proponowany zestaw procedur można rozbudować wedle uznania/potrzeb</p>
<ul>
<li>np. można dodać nowe/pomocnicze funkcje/procedury</li>
</ul>
<h1 id="zadanie-3---rozwi%C4%85zanie">Zadanie 3 - rozwiązanie</h1>
<pre class="hljs"><code><div>
<span class="hljs-comment">-- Dodawanie Rezerwacji</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">procedure</span> p_add_reservation(
    p_trip_id <span class="hljs-keyword">in</span> <span class="hljs-built_in">NUMBER</span>,
    p_person_id <span class="hljs-keyword">in</span> <span class="hljs-built_in">Number</span>
) <span class="hljs-keyword">AS</span>
    v_trip_date <span class="hljs-built_in">DATE</span>;
    v_available_seats NUMBER;
    v_reservation_id NUMBER;
    v_log_id NUMBER;
    v_trip_number NUMBER;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(*) <span class="hljs-keyword">into</span> v_trip_number <span class="hljs-keyword">from</span> TRIP <span class="hljs-keyword">where</span> TRIP_ID=p_trip_id;
    if v_trip_number&gt;0 THEN
        <span class="hljs-keyword">select</span> TRIP_DATE <span class="hljs-keyword">into</span> v_trip_date
        <span class="hljs-keyword">from</span> TRIP
            <span class="hljs-keyword">where</span> TRIP_ID=p_trip_id;
        IF v_trip_date&gt;SYSDATE then
            <span class="hljs-keyword">Select</span> MAX_NO_PLACES - (<span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(*) <span class="hljs-keyword">from</span> RESERVATION <span class="hljs-keyword">where</span> TRIP.TRIP_ID=RESERVATION.TRIP_ID <span class="hljs-keyword">and</span> RESERVATION.STATUS!=<span class="hljs-string">'C'</span>)
                <span class="hljs-keyword">into</span> v_available_seats
            <span class="hljs-keyword">from</span> TRIP
                <span class="hljs-keyword">where</span> TRIP_ID=p_trip_id;
            IF v_available_seats&gt;0 then
                <span class="hljs-keyword">select</span> <span class="hljs-keyword">Max</span>(RESERVATION_ID)+<span class="hljs-number">1</span> <span class="hljs-keyword">into</span> v_reservation_id <span class="hljs-keyword">from</span> RESERVATION;
                <span class="hljs-keyword">select</span> <span class="hljs-keyword">Max</span>(LOG_ID)+<span class="hljs-number">1</span> <span class="hljs-keyword">into</span> v_log_id <span class="hljs-keyword">from</span> <span class="hljs-keyword">LOG</span>;
                <span class="hljs-keyword">Insert</span> <span class="hljs-keyword">into</span> RESERVATION (reservation_id, trip_id, person_id, <span class="hljs-keyword">status</span>) <span class="hljs-keyword">VALUES</span>
                (v_reservation_id,p_trip_id,p_person_id,<span class="hljs-string">'P'</span>);
                <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">log</span> (LOG_ID, RESERVATION_ID, LOG_DATE, <span class="hljs-keyword">STATUS</span>)
                <span class="hljs-keyword">VALUES</span> (v_log_id, v_reservation_id,<span class="hljs-keyword">SYSDATE</span>,<span class="hljs-string">'P'</span>);
            ELSE
                DBMS_OUTPUT.PUT_LINE('No available seats for this trip.');
            <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;
            ELSE
                DBMS_OUTPUT.PUT_LINE('Trip has already been completed.');
        <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;
    ELSE
        DBMS_OUTPUT.PUT_LINE('There is no Trip <span class="hljs-keyword">with</span> that TRIP_ID<span class="hljs-string">');
    end if;
end;
/

-- Zmiana Rezerwacji
CREATE OR REPLACE PROCEDURE p_modify_reservation_status (
    p_reservation_id IN NUMBER,
    p_status IN VARCHAR2
) AS
    v_current_status VARCHAR2(20);
    v_trip_id NUMBER;
    v_trip_date DATE;
    v_log_id NUMBER;
    v_available_seats NUMBER;
    v_reservation_number NUMBER;
BEGIN
    select count(*) into v_reservation_number from RESERVATION where RESERVATION_ID=p_reservation_id;
    IF v_reservation_number&gt;0 THEN
        SELECT status INTO v_current_status
        FROM RESERVATION
        WHERE reservation_id = p_reservation_id;
        IF v_current_status != p_status THEN
            select TRIP_ID into v_trip_id from RESERVATION where RESERVATION_ID=p_reservation_id;
            select TRIP_DATE into v_trip_date from TRIP where TRIP_ID=v_trip_id;
            IF v_trip_date&gt;SYSDATE THEN
                Select MAX_NO_PLACES - (select count(*) from RESERVATION where TRIP.TRIP_ID=RESERVATION.TRIP_ID and RESERVATION.STATUS!='</span>C<span class="hljs-string">')
                into v_available_seats
                from TRIP
                    where TRIP_ID=v_trip_id;
                IF v_available_seats&gt;0 THEN
                    UPDATE RESERVATION
                    SET status = p_status
                    WHERE reservation_id = p_reservation_id;
                    select Max(LOG_ID)+1 into v_log_id from LOG;
                    INSERT INTO log (LOG_ID, RESERVATION_ID, LOG_DATE, STATUS)
                    VALUES (v_log_id, p_reservation_id,SYSDATE,p_status);
                ELSE
                    DBMS_OUTPUT.PUT_LINE('</span>Cannot <span class="hljs-keyword">modify</span> <span class="hljs-keyword">status</span> <span class="hljs-keyword">of</span> a reservation <span class="hljs-keyword">for</span> <span class="hljs-keyword">full</span> trip.<span class="hljs-string">');
                END IF;
            ELSE
            DBMS_OUTPUT.PUT_LINE('</span>Cannot <span class="hljs-keyword">modify</span> <span class="hljs-keyword">status</span> <span class="hljs-keyword">of</span> a reservation <span class="hljs-keyword">for</span> ended trip.<span class="hljs-string">');
            END IF;
        ELSE
            DBMS_OUTPUT.PUT_LINE('</span>Cannot <span class="hljs-keyword">modify</span> <span class="hljs-keyword">status</span> <span class="hljs-keyword">for</span> same status.<span class="hljs-string">');
        END IF;
    ELSE
            DBMS_OUTPUT.PUT_LINE('</span>There <span class="hljs-keyword">is</span> <span class="hljs-keyword">no</span> Reservation <span class="hljs-keyword">with</span> that RESERVATION_ID<span class="hljs-string">');
    END IF;
END;
/

--Zmiana liczby miejsc na wyjazd
CREATE OR REPLACE PROCEDURE p_modify_max_no_places (
    p_trip_id IN NUMBER,
    p_max_no_places IN NUMBER
) AS
    v_reserved_seats NUMBER;
    v_trip_number NUMBER;
BEGIN
    select count(*) into v_trip_number from TRIP where TRIP_ID=p_trip_id;
    if v_trip_number&gt;0 THEN
        Select (select count(*) from RESERVATION where TRIP.TRIP_ID=RESERVATION.TRIP_ID)
        into v_reserved_seats
        from TRIP
        where TRIP_ID=p_trip_id;
        IF p_max_no_places &gt;= v_reserved_seats THEN
            UPDATE TRIP
            SET max_no_places = p_max_no_places
            WHERE trip_id = p_trip_id;
        ELSE
            DBMS_OUTPUT.PUT_LINE('</span>Cannot decrease <span class="hljs-keyword">max</span> <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> places below reserved seats.<span class="hljs-string">');
        END IF;
    ELSE
        DBMS_OUTPUT.PUT_LINE('</span>There <span class="hljs-keyword">is</span> <span class="hljs-keyword">no</span> Trip <span class="hljs-keyword">with</span> that TRIP_ID.<span class="hljs-string">');
    END IF;
END;


</span></div></code></pre>
<hr>
<h1 id="zadanie-4---triggery">Zadanie 4 - triggery</h1>
<p>Zmiana strategii zapisywania do dziennika rezerwacji. Realizacja przy pomocy triggerów</p>
<p>Należy wprowadzić zmianę, która spowoduje, że zapis do dziennika rezerwacji będzie realizowany przy pomocy trierów</p>
<p>Triggery:</p>
<ul>
<li>trigger/triggery obsługujące
<ul>
<li>dodanie rezerwacji</li>
<li>zmianę statusu</li>
</ul>
</li>
<li>trigger zabraniający usunięcia rezerwacji</li>
</ul>
<p>Oczywiście po wprowadzeniu tej zmiany należy &quot;uaktualnić&quot; procedury modyfikujące dane.</p>
<blockquote>
<p>UWAGA
Należy stworzyć nowe wersje tych procedur (dodając do nazwy dopisek 4 - od numeru zadania). Poprzednie wersje procedur należy pozostawić w celu umożliwienia weryfikacji ich poprawności</p>
</blockquote>
<p>Należy przygotować procedury: <code>p_add_reservation_4</code>, <code>p_modify_reservation_status_4</code></p>
<h1 id="zadanie-4---rozwi%C4%85zanie">Zadanie 4 - rozwiązanie</h1>
<pre class="hljs"><code><div>

<span class="hljs-comment">-- Trigger dodający dodanie Rezerwacji do Logów</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> trg_add_reservation_log
<span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> RESERVATION
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">LOG</span> (LOG_ID, RESERVATION_ID, LOG_DATE, <span class="hljs-keyword">STATUS</span>)
    <span class="hljs-keyword">VALUES</span> ((<span class="hljs-keyword">SELECT</span> NVL(<span class="hljs-keyword">MAX</span>(log_id), <span class="hljs-number">0</span>) + <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">LOG</span>),
            :NEW.reservation_id,
            <span class="hljs-keyword">SYSDATE</span>,
            <span class="hljs-string">'P'</span>);
<span class="hljs-keyword">END</span>;
/

<span class="hljs-comment">-- Trigger dodający zmiane statusu Rezerwacji do Logów</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> trg_modify_reservation_status_log
<span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">OF</span> <span class="hljs-keyword">status</span> <span class="hljs-keyword">ON</span> RESERVATION
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">LOG</span> (LOG_ID, RESERVATION_ID, LOG_DATE, <span class="hljs-keyword">STATUS</span>)
    <span class="hljs-keyword">VALUES</span> ((<span class="hljs-keyword">SELECT</span> NVL(<span class="hljs-keyword">MAX</span>(log_id), <span class="hljs-number">0</span>) + <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">LOG</span>),
            :OLD.reservation_id,
            <span class="hljs-keyword">SYSDATE</span>,
            :NEW.status);
<span class="hljs-keyword">END</span>;
/

<span class="hljs-comment">-- Trigger blokujący usuwanie Rezerwacji</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> trg_prevent_reservation_deletion
<span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">ON</span> RESERVATION
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">BEGIN</span>
    RAISE_APPLICATION_ERROR(<span class="hljs-number">-20001</span>, <span class="hljs-string">'Deletion of reservation not allowed.'</span>);
<span class="hljs-keyword">END</span>;
/

<span class="hljs-comment">-- Dodawanie Rezerwacji (nowe)</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">procedure</span> p_add_reservation_4(
    p_trip_id <span class="hljs-keyword">in</span> <span class="hljs-built_in">NUMBER</span>,
    p_person_id <span class="hljs-keyword">in</span> <span class="hljs-built_in">Number</span>
) <span class="hljs-keyword">AS</span>
    v_trip_date <span class="hljs-built_in">DATE</span>;
    v_available_seats NUMBER;
    v_reservation_id NUMBER;
    v_log_id NUMBER;
    v_trip_number NUMBER;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(*) <span class="hljs-keyword">into</span> v_trip_number <span class="hljs-keyword">from</span> TRIP <span class="hljs-keyword">where</span> TRIP_ID=p_trip_id;
    if v_trip_number&gt;0 THEN
        <span class="hljs-keyword">select</span> TRIP_DATE <span class="hljs-keyword">into</span> v_trip_date
        <span class="hljs-keyword">from</span> TRIP
            <span class="hljs-keyword">where</span> TRIP_ID=p_trip_id;
        IF v_trip_date&gt;SYSDATE then
            <span class="hljs-keyword">Select</span> MAX_NO_PLACES - (<span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(*) <span class="hljs-keyword">from</span> RESERVATION <span class="hljs-keyword">where</span> TRIP.TRIP_ID=RESERVATION.TRIP_ID <span class="hljs-keyword">and</span> RESERVATION.STATUS!=<span class="hljs-string">'C'</span>)
                <span class="hljs-keyword">into</span> v_available_seats
            <span class="hljs-keyword">from</span> TRIP
                <span class="hljs-keyword">where</span> TRIP_ID=p_trip_id;
            IF v_available_seats&gt;0 then
                <span class="hljs-keyword">select</span> <span class="hljs-keyword">Max</span>(RESERVATION_ID)+<span class="hljs-number">1</span> <span class="hljs-keyword">into</span> v_reservation_id <span class="hljs-keyword">from</span> RESERVATION;
                <span class="hljs-keyword">select</span> <span class="hljs-keyword">Max</span>(LOG_ID)+<span class="hljs-number">1</span> <span class="hljs-keyword">into</span> v_log_id <span class="hljs-keyword">from</span> <span class="hljs-keyword">LOG</span>;
                <span class="hljs-keyword">Insert</span> <span class="hljs-keyword">into</span> RESERVATION (reservation_id, trip_id, person_id, <span class="hljs-keyword">status</span>) <span class="hljs-keyword">VALUES</span>
                (v_reservation_id,p_trip_id,p_person_id,<span class="hljs-string">'P'</span>);
            ELSE
                DBMS_OUTPUT.PUT_LINE('No available seats for this trip.');
            <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;
            ELSE
                DBMS_OUTPUT.PUT_LINE('Trip has already been completed.');
        <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;
    ELSE
        DBMS_OUTPUT.PUT_LINE('There is no Trip <span class="hljs-keyword">with</span> that TRIP_ID<span class="hljs-string">');
    end if;
end;
/


/

-- Zmiana statusus Rezerwacji (nowe)
create or replace PROCEDURE p_modify_reservation_status_4 (
    p_reservation_id IN NUMBER,
    p_status IN VARCHAR2
) AS
    v_current_status VARCHAR2(20);
    v_trip_id NUMBER;
    v_trip_date DATE;
    v_log_id NUMBER;
    v_available_seats NUMBER;
    v_reservation_number NUMBER;
BEGIN
    select count(*) into v_reservation_number from RESERVATION where RESERVATION_ID=p_reservation_id;
    IF v_reservation_number&gt;0 THEN
        SELECT status INTO v_current_status
        FROM RESERVATION
        WHERE reservation_id = p_reservation_id;
        IF v_current_status != p_status THEN
            select TRIP_ID into v_trip_id from RESERVATION where RESERVATION_ID=p_reservation_id;
            select TRIP_DATE into v_trip_date from TRIP where TRIP_ID=v_trip_id;
            IF v_trip_date&gt;SYSDATE THEN
                Select MAX_NO_PLACES - (select count(*) from RESERVATION where TRIP.TRIP_ID=RESERVATION.TRIP_ID and RESERVATION.STATUS!='</span>C<span class="hljs-string">')
                into v_available_seats
                from TRIP
                    where TRIP_ID=v_trip_id;
                IF v_available_seats&gt;0 THEN
                    UPDATE RESERVATION
                    SET status = p_status
                    WHERE reservation_id = p_reservation_id;
                    select Max(LOG_ID)+1 into v_log_id from LOG;
                ELSE
                    DBMS_OUTPUT.PUT_LINE('</span>Cannot <span class="hljs-keyword">modify</span> <span class="hljs-keyword">status</span> <span class="hljs-keyword">of</span> a reservation <span class="hljs-keyword">for</span> <span class="hljs-keyword">full</span> trip.<span class="hljs-string">');
                END IF;
            ELSE
            DBMS_OUTPUT.PUT_LINE('</span>Cannot <span class="hljs-keyword">modify</span> <span class="hljs-keyword">status</span> <span class="hljs-keyword">of</span> a reservation <span class="hljs-keyword">for</span> ended trip.<span class="hljs-string">');
            END IF;
        ELSE
            DBMS_OUTPUT.PUT_LINE('</span>Cannot <span class="hljs-keyword">modify</span> <span class="hljs-keyword">status</span> <span class="hljs-keyword">for</span> same status.<span class="hljs-string">');
        END IF;
    ELSE
            DBMS_OUTPUT.PUT_LINE('</span>There <span class="hljs-keyword">is</span> <span class="hljs-keyword">no</span> Reservation <span class="hljs-keyword">with</span> that RESERVATION_ID<span class="hljs-string">');
    END IF;
END;
/


/

</span></div></code></pre>
<hr>
<h1 id="zadanie-5---triggery">Zadanie 5 - triggery</h1>
<p>Zmiana strategii kontroli dostępności miejsc. Realizacja przy pomocy triggerów</p>
<p>Należy wprowadzić zmianę, która spowoduje, że kontrola dostępności miejsc na wycieczki (przy dodawaniu nowej rezerwacji, zmianie statusu) będzie realizowana przy pomocy trierów</p>
<p>Triggery:</p>
<ul>
<li>Trigger/triggery obsługujące:
<ul>
<li>dodanie rezerwacji</li>
<li>zmianę statusu</li>
</ul>
</li>
</ul>
<p>Oczywiście po wprowadzeniu tej zmiany należy &quot;uaktualnić&quot; procedury modyfikujące dane.</p>
<blockquote>
<p>UWAGA
Należy stworzyć nowe wersje tych procedur (np. dodając do nazwy dopisek 5 - od numeru zadania). Poprzednie wersje procedur należy pozostawić w celu umożliwienia weryfikacji ich poprawności.</p>
</blockquote>
<p>Należy przygotować procedury: <code>p_add_reservation_5</code>, <code>p_modify_reservation_status_5</code></p>
<h1 id="zadanie-5---rozwi%C4%85zanie">Zadanie 5 - rozwiązanie</h1>
<pre class="hljs"><code><div><span class="hljs-comment">-- Trigger sprawdzający czy są wolne miejsca na wyjazd</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">trigger</span> TRG_CHECK_SEAT_AVAILABILITY_ADD_RESERVATION
    <span class="hljs-keyword">before</span> <span class="hljs-keyword">insert</span>
    <span class="hljs-keyword">on</span> RESERVATION
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> <span class="hljs-keyword">row</span>
<span class="hljs-keyword">DECLARE</span>
    v_available_seats <span class="hljs-built_in">NUMBER</span>;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">Select</span> MAX_NO_PLACES - (<span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(*) <span class="hljs-keyword">from</span> RESERVATION <span class="hljs-keyword">where</span> TRIP.TRIP_ID=RESERVATION.TRIP_ID <span class="hljs-keyword">and</span> RESERVATION.STATUS!=<span class="hljs-string">'C'</span>)
                <span class="hljs-keyword">into</span> v_available_seats
            <span class="hljs-keyword">from</span> TRIP
                <span class="hljs-keyword">where</span> TRIP_ID=new.trip_id;

    IF v_available_seats &lt;= 0 THEN
        RAISE_APPLICATION_ERROR(-20001, 'No available seats for this trip.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
<span class="hljs-keyword">END</span>;
/

<span class="hljs-comment">--Trigger sprawdzający czy wyjazd sie już nie odbył</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> trg_check_date_add_reservation
<span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> RESERVATION
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">DECLARE</span>
    v_trip_date <span class="hljs-built_in">DATE</span>;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span> TRIP_DATE <span class="hljs-keyword">INTO</span> v_trip_date
    <span class="hljs-keyword">FROM</span> TRIP
    <span class="hljs-keyword">WHERE</span> TRIP_ID = :NEW.trip_id;

    IF v_trip_date &lt;= SYSDATE THEN
        DBMS_OUTPUT.PUT_LINE('Trip has already been completed.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
<span class="hljs-keyword">END</span>;

<span class="hljs-comment">-- Trigger sprawdzający czy są wolne miejsca lub czy nie odbył sie wyjazd dla rezerwacji której zmieniamy status</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">trigger</span> TRG_CHECK_SEAT_AVAILABILITY_MODIFY_STATUS
    <span class="hljs-keyword">before</span> <span class="hljs-keyword">update</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">STATUS</span>
    <span class="hljs-keyword">on</span> RESERVATION
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> <span class="hljs-keyword">row</span>
<span class="hljs-keyword">DECLARE</span>
    v_available_seats <span class="hljs-built_in">NUMBER</span>;
    v_trip_date DATE;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">Select</span> MAX_NO_PLACES - (<span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(*) <span class="hljs-keyword">from</span> RESERVATION <span class="hljs-keyword">where</span> TRIP.TRIP_ID=RESERVATION.TRIP_ID <span class="hljs-keyword">and</span> <span class="hljs-keyword">STATUS</span>!=<span class="hljs-string">'C'</span>)
    <span class="hljs-keyword">into</span> v_available_seats
    <span class="hljs-keyword">from</span> TRIP
    <span class="hljs-keyword">where</span> TRIP_ID=new.trip_id;
    IF v_available_seats &lt;= 0 THEN
        RAISE_APPLICATION_ERROR(-20001, 'Cannot modify status of a reservation for a full trip.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
    <span class="hljs-keyword">SELECT</span> TRIP_DATE <span class="hljs-keyword">INTO</span> v_trip_date
    <span class="hljs-keyword">FROM</span> TRIP
    <span class="hljs-keyword">WHERE</span> TRIP_ID = OLD.TRIP_ID;

    IF v_trip_date &lt;= SYSDATE THEN
        RAISE_APPLICATION_ERROR(-20002, 'Cannot modify status of a reservation for ended trip.');
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
<span class="hljs-keyword">END</span>;
/


/

<span class="hljs-comment">-- Dodawanie Rezerwacji (nowsze)</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">PROCEDURE</span> p_add_reservation_5(
    p_trip_id <span class="hljs-keyword">IN</span> <span class="hljs-built_in">NUMBER</span>,
    p_person_id <span class="hljs-keyword">IN</span> <span class="hljs-built_in">NUMBER</span>
)<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> RESERVATION (reservation_id, trip_id, person_id, <span class="hljs-keyword">status</span>)
    <span class="hljs-keyword">VALUES</span> ((<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">MAX</span>(reservation_id) + <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> RESERVATION), p_trip_id, p_person_id, <span class="hljs-string">'P'</span>);
<span class="hljs-keyword">END</span>;
/



<span class="hljs-comment">-- Zmiana statusus Rezerwacji (nowsze)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">PROCEDURE</span> p_modify_reservation_status_5(
    p_reservation_id <span class="hljs-keyword">IN</span> <span class="hljs-built_in">NUMBER</span>,
    p_status <span class="hljs-keyword">IN</span> <span class="hljs-built_in">VARCHAR2</span>
) <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">UPDATE</span> RESERVATION
    <span class="hljs-keyword">SET</span> <span class="hljs-keyword">status</span> = p_status
    <span class="hljs-keyword">WHERE</span> reservation_id = p_reservation_id;
<span class="hljs-keyword">END</span>;
/

</div></code></pre>
<hr>
<h1 id="zadanie-6">Zadanie 6</h1>
<p>Zmiana struktury bazy danych. W tabeli <code>trip</code> należy dodać redundantne pole <code>no_available_places</code>. Dodanie redundantnego pola uprości kontrolę dostępnych miejsc, ale nieco skomplikuje procedury dodawania rezerwacji, zmiany statusu czy też zmiany maksymalnej liczby miejsc na wycieczki.</p>
<p>Należy przygotować polecenie/procedurę przeliczającą wartość pola <code>no_available_places</code> dla wszystkich wycieczek (do jednorazowego wykonania)</p>
<p>Obsługę pola <code>no_available_places</code> można zrealizować przy pomocy procedur lub triggerów</p>
<p>Należy zwrócić uwagę na spójność rozwiązania.</p>
<blockquote>
<p>UWAGA
Należy stworzyć nowe wersje tych widoków/procedur/triggerów (np. dodając do nazwy dopisek 6 - od numeru zadania). Poprzednie wersje procedur należy pozostawić w celu umożliwienia weryfikacji ich poprawności.</p>
</blockquote>
<ul>
<li>zmiana struktury tabeli</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> trip <span class="hljs-keyword">add</span>
    no_available_places <span class="hljs-built_in">int</span> <span class="hljs-literal">null</span>
</div></code></pre>
<ul>
<li>polecenie przeliczające wartość <code>no_available_places</code>
<ul>
<li>należy wykonać operację &quot;przeliczenia&quot; liczby wolnych miejsc i aktualizacji pola <code>no_available_places</code></li>
</ul>
</li>
</ul>
<h1 id="zadanie-6---rozwi%C4%85zanie">Zadanie 6 - rozwiązanie</h1>
<pre class="hljs"><code><div>
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> trip <span class="hljs-keyword">add</span>
no_available_places <span class="hljs-built_in">int</span> <span class="hljs-literal">null</span>;

<span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">procedure</span> p_recalculate_available_places <span class="hljs-keyword">as</span>
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">for</span> <span class="hljs-built_in">record</span> <span class="hljs-keyword">in</span> (<span class="hljs-keyword">select</span> trip_id, max_no_places <span class="hljs-keyword">from</span> trip) <span class="hljs-keyword">loop</span>
        <span class="hljs-keyword">update</span> trip
        <span class="hljs-keyword">set</span> no_available_places = record.max_no_places - (
            <span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(*)
            <span class="hljs-keyword">from</span> reservation
            <span class="hljs-keyword">where</span> trip_id = record.trip_id
            <span class="hljs-keyword">and</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'P'</span>
        )
        <span class="hljs-keyword">where</span> trip_id = record.trip_id;
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">loop</span>;
    <span class="hljs-keyword">commit</span>;
<span class="hljs-keyword">end</span>;

<span class="hljs-keyword">begin</span>
    p_recalculate_available_places;
<span class="hljs-keyword">end</span>;


W tym zadaniu najpierw dodajemy pole no_available_places <span class="hljs-keyword">do</span> tabeli trip, 
następnie tworzymy <span class="hljs-keyword">procedure</span>, która odejmuje od maksymalnej liczby miejsc w danej wyciecze wszystkie miejsca, które są zajęte
przez rezerawcje potwierdzone i zapłacone. Wywołując tą procedurę jednokrotnie nowo dodane pole w tabeli trip jest wypełniane wartościami

</div></code></pre>
<hr>
<h1 id="zadanie-6a---procedury">Zadanie 6a - procedury</h1>
<p>Obsługę pola <code>no_available_places</code> należy zrealizować przy pomocy procedur</p>
<ul>
<li>procedura dodająca rezerwację powinna aktualizować pole <code>no_available_places</code> w tabeli trip</li>
<li>podobnie procedury odpowiedzialne za zmianę statusu oraz zmianę maksymalnej liczby miejsc na wycieczkę</li>
<li>należy przygotować procedury oraz jeśli jest to potrzebne, zaktualizować triggery oraz widoki</li>
</ul>
<blockquote>
<p>UWAGA
Należy stworzyć nowe wersje tych widoków/procedur/triggerów (np. dodając do nazwy dopisek 6a - od numeru zadania). Poprzednie wersje procedur należy pozostawić w celu umożliwienia weryfikacji ich poprawności.</p>
</blockquote>
<ul>
<li>może być potrzebne wyłączenie 'poprzednich wersji' triggerów</li>
</ul>
<h1 id="zadanie-6a---rozwi%C4%85zanie">Zadanie 6a - rozwiązanie</h1>
<pre class="hljs"><code><div>
<span class="hljs-comment">--dodawanie rezerwacji</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">PROCEDURE</span> p_add_reservation_6(
    p_trip_id <span class="hljs-keyword">IN</span> trip.trip_id%<span class="hljs-keyword">TYPE</span>,
    p_person_id <span class="hljs-keyword">IN</span> reservation.person_id%<span class="hljs-keyword">TYPE</span>
) <span class="hljs-keyword">AS</span>
    v_max_places trip.max_no_places%<span class="hljs-keyword">TYPE</span>;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span> max_no_places <span class="hljs-keyword">INTO</span> v_max_places <span class="hljs-keyword">FROM</span> trip <span class="hljs-keyword">WHERE</span> trip_id = p_trip_id;

    <span class="hljs-keyword">UPDATE</span> trip
    <span class="hljs-keyword">SET</span> no_available_places = no_available_places - <span class="hljs-number">1</span>
    <span class="hljs-keyword">WHERE</span> trip_id = p_trip_id
    <span class="hljs-keyword">AND</span> no_available_places &gt; <span class="hljs-number">0</span>;

    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> reservation (trip_id, person_id, <span class="hljs-keyword">status</span>)
    <span class="hljs-keyword">VALUES</span> (p_trip_id, p_person_id, <span class="hljs-string">'N'</span>);
<span class="hljs-keyword">END</span>;
/

<span class="hljs-comment">--modyfikacja statusu rezerwacji</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">PROCEDURE</span> p_modify_reservation_status_6(
    p_reservation_id <span class="hljs-keyword">IN</span> reservation.reservation_id%<span class="hljs-keyword">TYPE</span>,
    p_new_status <span class="hljs-keyword">IN</span> reservation.status%<span class="hljs-keyword">TYPE</span>
) <span class="hljs-keyword">AS</span>
    v_trip_id reservation.trip_id%<span class="hljs-keyword">TYPE</span>;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span> trip_id <span class="hljs-keyword">INTO</span> v_trip_id <span class="hljs-keyword">FROM</span> reservation <span class="hljs-keyword">WHERE</span> reservation_id = p_reservation_id;

    IF p_new_status = 'C' THEN
        <span class="hljs-keyword">UPDATE</span> trip
        <span class="hljs-keyword">SET</span> no_available_places = no_available_places + <span class="hljs-number">1</span>
        <span class="hljs-keyword">WHERE</span> trip_id = v_trip_id;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">UPDATE</span> reservation
    <span class="hljs-keyword">SET</span> <span class="hljs-keyword">status</span> = p_new_status
    <span class="hljs-keyword">WHERE</span> reservation_id = p_reservation_id;

<span class="hljs-keyword">END</span>;
/

<span class="hljs-comment">--zmiana maksymalnej liczby miejsc wycieczki</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> p_update_max_places(
    p_trip_id <span class="hljs-keyword">IN</span> trip.trip_id%<span class="hljs-keyword">TYPE</span>,
    p_new_max_places <span class="hljs-keyword">IN</span> trip.max_no_places%<span class="hljs-keyword">TYPE</span>
) <span class="hljs-keyword">AS</span>
    v_diff_places <span class="hljs-built_in">NUMBER</span>;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span> p_new_max_places - max_no_places <span class="hljs-keyword">INTO</span> v_diff_places
    <span class="hljs-keyword">FROM</span> trip
    <span class="hljs-keyword">WHERE</span> trip_id = p_trip_id;

    <span class="hljs-keyword">UPDATE</span> trip
    <span class="hljs-keyword">SET</span> no_available_places = no_available_places + v_diff_places,
        max_no_places = p_new_max_places
    <span class="hljs-keyword">WHERE</span> trip_id = p_trip_id;

<span class="hljs-keyword">END</span>;
/

</div></code></pre>
<hr>
<h1 id="zadanie-6b---triggery">Zadanie 6b - triggery</h1>
<p>Obsługę pola <code>no_available_places</code> należy zrealizować przy pomocy triggerów</p>
<ul>
<li>podczas dodawania rezerwacji trigger powinien aktualizować pole <code>no_available_places</code> w tabeli trip</li>
<li>podobnie, podczas zmiany statusu rezerwacji</li>
<li>należy przygotować trigger/triggery oraz jeśli jest to potrzebne, zaktualizować procedury modyfikujące dane oraz widoki</li>
</ul>
<blockquote>
<p>UWAGA
Należy stworzyć nowe wersje tych widoków/procedur/triggerów (np. dodając do nazwy dopisek 6b - od numeru zadania). Poprzednie wersje procedur należy pozostawić w celu umożliwienia weryfikacji ich poprawności.</p>
</blockquote>
<ul>
<li>może być potrzebne wyłączenie 'poprzednich wersji' triggerów</li>
</ul>
<h1 id="zadanie-6b---rozwi%C4%85zanie">Zadanie 6b - rozwiązanie</h1>
<pre class="hljs"><code><div>
<span class="hljs-comment">-- trigger przy dodaniu nowej rezerwacji</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">trigger</span> TRG_RESERVATION_ADDED_6
    <span class="hljs-keyword">after</span> <span class="hljs-keyword">insert</span>
    <span class="hljs-keyword">on</span> RESERVATION
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> <span class="hljs-keyword">row</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">UPDATE</span> trip
    <span class="hljs-keyword">SET</span> no_available_places = no_available_places - <span class="hljs-number">1</span>
    <span class="hljs-keyword">WHERE</span> trip_id = :NEW.trip_id;
<span class="hljs-keyword">END</span>;
/

<span class="hljs-comment">--trigger przy odwołaniu rezerwacji</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">trigger</span> TRG_RESERVATION_STATUS_CHANGED_6
    <span class="hljs-keyword">after</span> <span class="hljs-keyword">update</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">STATUS</span>
    <span class="hljs-keyword">on</span> RESERVATION
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> <span class="hljs-keyword">row</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">IF</span> :OLD.status &lt;&gt; <span class="hljs-string">'C'</span> <span class="hljs-keyword">AND</span> :NEW.status = <span class="hljs-string">'C'</span> <span class="hljs-keyword">THEN</span>
        <span class="hljs-keyword">UPDATE</span> trip
        <span class="hljs-keyword">SET</span> no_available_places = no_available_places + <span class="hljs-number">1</span>
        <span class="hljs-keyword">WHERE</span> trip_id = :NEW.trip_id;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
<span class="hljs-keyword">END</span>;
/



</div></code></pre>
<h1 id="zadanie-7---podsumowanie">Zadanie 7 - podsumowanie</h1>
<p>Porównaj sposób programowania w systemie Oracle PL/SQL ze znanym ci systemem/językiem MS Sqlserver T-SQL</p>
<pre class="hljs"><code><div>
Oracle PL/SQL i MS Sqlserver T-SQL działają w ogólności podobnie i pozwalają na
programowanie relacyjnych baz danych, oraz interakcji wewnątrz nich.
Różnice porównamy na kilku płaszczyznach:
a) Typy danych: 
Oracle PL/SQL posiada wsparcie dla typów prostych(np.
NUMBER, VARCHAR2, DATE), typów kolekcji (np. TABLE OF, VARRAY),
typów obiektowych(np. OBJECT), typów tablicy asocjacyjnej (np. PL/SQL TABLE)
T-SQL posiada wsparcie dla typów podobnych co Oracle (np. NUMBER, VARCHAR, DATE),
ale generalnie ich zasób jest nieco mniejszy, natomiast na bardziej złożone
struktury danych pozwala typ tabli(TABLE)
b) Funkcjonalność:
Oba języki wykorzystują podobne konstrukcje takie jak:
<span class="hljs-keyword">BEGIN</span> ... <span class="hljs-keyword">END</span>, <span class="hljs-keyword">IF</span> ... <span class="hljs-keyword">ELSE</span>, <span class="hljs-keyword">WHILE</span>, <span class="hljs-keyword">CASE</span>, <span class="hljs-keyword">LOOP</span>
<span class="hljs-keyword">Oracle</span> <span class="hljs-keyword">SQL</span> ponadto posiada swoje unikalne konstrukcje takie jak: <span class="hljs-keyword">FORALL</span>,
<span class="hljs-keyword">BULK</span> <span class="hljs-keyword">COLLECT</span>, <span class="hljs-keyword">EXCEPTION</span> INIT
Natomiast T-<span class="hljs-keyword">SQL</span> skupia się dodatkowo na danych zapisanych w <span class="hljs-keyword">SQL</span> <span class="hljs-keyword">Server</span> <span class="hljs-keyword">do</span> których
daje nam dostęp funkcjami takimi jak : TOP, <span class="hljs-keyword">SET</span> ROWCOUNT, 
CTE (Common <span class="hljs-keyword">Table</span> Expressions)
c) Funkcje analityczne: 
W <span class="hljs-keyword">Oracle</span> PL/<span class="hljs-keyword">SQL</span> mamy funkcje takie jak: LAG, <span class="hljs-keyword">LEAD</span>, ROW_NUMBER,
które umożliwiają wykonywanie zaawansowanych operacji
analitycznych bez konieczności pisania złożonych zapytań.
W T-<span class="hljs-keyword">SQL</span> również mamy takie funkcję, chociaż ich zakres nieco się różni, są <span class="hljs-keyword">to</span> np.
ROW_NUMBER(), <span class="hljs-keyword">RANK</span>(), <span class="hljs-keyword">DENSE_RANK</span>().
Wnioski: 
Programowanie w PL/<span class="hljs-keyword">SQL</span> oraz T-<span class="hljs-keyword">SQL</span> co <span class="hljs-keyword">do</span> zasady jest bardzo
podobne, ponieważ oba języki mają podobne zastosowanie,
różnice obawiają się w składni, dostępnych funkcjach oraz typach danych czy
praktykach takich jak zmienne globalne, których w PL/<span class="hljs-keyword">SQL</span> stosuje się trochę więcej
Główna różnica jest natomiast platforma z której korzystamy
przy rozwiązaniach microsoftu prawdopodobnie łatwiej będzie
obsługiwać je bazą z T-<span class="hljs-keyword">SQL</span>, natomiast w pozostałych OracleDatabase sprawdza się
równie dobrze
</div></code></pre>

</body>
</html>
